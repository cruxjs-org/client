import {signal,effect}from'@minejs/signals';import {mount}from'@minejs/jsx';import {EventsManager,WindowManager}from'@minejs/browser';import {setupI18n}from'@minejs/i18n';var l=class extends Error{constructor(e,r,o){super(r);this.code=e;this.cause=o;this.name="NavigationError";}};var h=class{constructor(t,e=null,r=new Map,o,n=false){this.segment=t;this.route=e;this.children=r;this.paramName=o;this.isWildcard=n;}},y=class{constructor(){this.root=new h("");this.wildcardRoute=null;}addRoute(t,e=""){let r=e+t.path;if(r==="/*"||r==="*"){this.wildcardRoute=t;return}let o=r.split("/").filter(Boolean),n=this.root;for(let a of o){let c=a.startsWith(":"),s=c?":param":a;n.children.has(s)||n.children.set(s,new h(a,null,new Map,c?a.slice(1):void 0)),n=n.children.get(s);}n.route=t,t.children&&t.children.forEach(a=>this.addRoute(a,r));}match(t){let e=t.split("/").filter(Boolean),r={},o=this.root,n=null;for(let c of e)if(o.children.has(c))o=o.children.get(c);else if(o.children.has(":param")){let s=o.children.get(":param");r[s.paramName]=decodeURIComponent(c),o=s;}else {n=this.wildcardRoute;break}if(n=n||o.route,!n)return null;let a=new URL(window.location.href);return {path:t,params:r,query:a.searchParams,hash:a.hash.slice(1),route:n}}},m=class{constructor(t){this.matcher=new y;this.currentRoute=signal(null);this.isNavigating=signal(false);this.loaderData=signal(null);this.error=signal(null);this.history=[];this.historyIndex=0;this.maxHistory=50;this.beforeEachGuards=[];this.afterEachGuards=[];this.onErrorHandlers=[];this.config={mode:"history",base:"",scrollBehavior:"auto",...t},t.onError&&this.onErrorHandlers.push(t.onError),t.routes.forEach(e=>this.matcher.addRoute(e)),this.setupListeners(),this.performNavigation(window.location.pathname+window.location.search);}emitError(t){this.error.set(t),this.onErrorHandlers.forEach(e=>e(t));}setupListeners(){this.config.mode==="history"?window.addEventListener("popstate",()=>{this.handleNavigation(window.location.pathname+window.location.search);}):window.addEventListener("hashchange",()=>{let t=window.location.hash.slice(1);this.handleNavigation(t||"/");}),document.addEventListener("click",t=>{let e=t.target.closest("a");if(!e||!e.href)return;let r=new URL(e.href);r.origin===window.location.origin&&(e.hasAttribute("data-external")||e.getAttribute("target")!=="_blank"&&(t.ctrlKey||t.metaKey||t.shiftKey||(t.preventDefault(),this.push(r.pathname+r.search))));});}performNavigation(t,e={}){try{let[r,o]=t.split("?"),n=new URL("http://localhost"+r+(o?"?"+o:""));this.config.allowedQueryParams&&this.config.allowedQueryParams.length>0&&Array.from(n.searchParams.keys()).forEach(p=>{this.config.allowedQueryParams.some(f=>typeof f=="string"?f===p:f.test(p))||n.searchParams.delete(p);});let a=n.searchParams.toString(),c=r+(a?"?"+a:""),s=this.matcher.match(r);if(!s){let w=new l("ROUTE_NOT_FOUND",`No route matched: ${r}`);this.emitError(w);return}if(this.config.mode==="history"?e.replace?window.history.replaceState(e.state||{},"",c):window.history.pushState(e.state||{},"",c):window.location.hash=c,s.query=n.searchParams,s.path=r,this.checkSyncGuards(s,this.currentRoute())===!1){window.history.back();return}this.error.set(null),this.currentRoute.set(s),this.handleScroll(e.scroll),this.updateMetaTags(s.route.meta),this.pruneHistory(),this.history.push(s),this.historyIndex=this.history.length-1,this.runAsyncNavigation(t,s,e);}catch(r){let o=new l("GUARD_ERROR","Navigation failed: "+String(r),r instanceof Error?r:void 0);this.emitError(o);}}updateMetaTags(t){if(t&&(t.title&&(document.title=t.title),t.description)){let e=document.querySelector('meta[name="description"]');if(e)e.content=t.description;else {let r=document.createElement("meta");r.name="description",r.content=t.description,document.head.appendChild(r);}}}pruneHistory(){this.history.length>this.maxHistory&&(this.history=this.history.slice(-this.maxHistory),this.historyIndex=this.history.length-1);}checkSyncGuards(t,e){if(this.beforeEachGuards.length!==0){for(let r of this.beforeEachGuards){let o=r(t,e);if(o instanceof Promise)return;if(o===false)return  false}return  true}}async runAsyncNavigation(t,e,r){try{if(!await this.runBeforeEachGuards(e,e)){this.currentRoute.set(null),this.history.pop(),this.historyIndex=Math.max(-1,this.history.length-1),window.history.back();return}let n=e;this.isNavigating.set(!0);try{if(e.route.loader){let a={params:e.params,query:e.query,request:new Request(window.location.href),pathname:t};try{let c=await e.route.loader(a);this.loaderData.set(c);}catch(c){let s=new l("LOADER_ERROR",`Failed to load data for ${t}`,c instanceof Error?c:void 0);throw this.emitError(s),s}}else this.loaderData.set(null);this.runAfterEachGuards(e,n);}finally{this.isNavigating.set(!1);}}catch(o){if(o instanceof l)throw o;let n=new l("GUARD_ERROR","Async navigation failed",o instanceof Error?o:void 0);this.emitError(n);}}async handleNavigation(t,e={}){this.performNavigation(t,e);}async runBeforeEachGuards(t,e){for(let r of this.beforeEachGuards)if(await r(t,e)===false)return  false;return  true}runAfterEachGuards(t,e){this.afterEachGuards.forEach(r=>r(t,e));}handleScroll(t){if(t===false)return;let e=typeof t=="string"?t:this.config.scrollBehavior;typeof window<"u"&&window.scrollTo&&window.scrollTo({top:0,left:0,behavior:e==="smooth"?"smooth":"auto"});}push(t,e={}){this.handleNavigation(t,{...e,replace:false});}replace(t,e={}){this.handleNavigation(t,{...e,replace:true});}back(){window.history.back();}forward(){window.history.forward();}go(t){window.history.go(t);}isActive(t,e=false){let r=this.currentRoute();return r?e?r.path===t:r.path.startsWith(t):false}getParams(){return this.currentRoute()?.params||{}}getQuery(){return this.currentRoute()?.query||new URLSearchParams}beforeEach(t){return this.beforeEachGuards.push(t),()=>{let e=this.beforeEachGuards.indexOf(t);e>-1&&this.beforeEachGuards.splice(e,1);}}afterEach(t){return this.afterEachGuards.push(t),()=>{let e=this.afterEachGuards.indexOf(t);e>-1&&this.afterEachGuards.splice(e,1);}}onError(t){return this.onErrorHandlers.push(t),()=>{let e=this.onErrorHandlers.indexOf(t);e>-1&&this.onErrorHandlers.splice(e,1);}}addAllowedQueryParam(t){this.config.allowedQueryParams||(this.config.allowedQueryParams=[]),this.config.allowedQueryParams.push(t);}async reload(){let t=this.currentRoute();if(t){let e=t.query.toString(),r=t.path+(e?"?"+e:"");await this.handleNavigation(r,{replace:true});}}destroy(){this.history=[],this.beforeEachGuards=[],this.afterEachGuards=[],this.onErrorHandlers=[],this.currentRoute.set(null),this.loaderData.set(null),this.error.set(null);}},E=null;function b(i){return E=new m(i),E}var x,d=class{constructor(t){this.lifecycle="booting";this.hooks={};this.extensions=[];this.routeComponents={};this.currentPathSignal=signal(window.location.pathname??"/");this.config=t,this.debug=t.debug??false,this.log("[INIT] Creating ClientManager"),t.lifecycle&&(this.hooks={...t.lifecycle}),this.extensions=t.extensions??[],this.routeComponents=t.routes,this.eventsManager=new EventsManager,this.windowManager=new WindowManager;let e=Object.entries(t.routes).map(([r,o])=>({path:r,component:o}));this.router=b({routes:e,notFoundComponent:t.notFoundComponent,allowedQueryParams:t.allowedQueryParams}),this.router.afterEach(r=>{this.currentPathSignal.set(r.path);}),x=this,this.log("[INIT] ClientManager created");}on(t,e,r,o){return typeof t=="string"&&t.startsWith("on")?(this.hooks[t]=e,this):this.eventsManager.on(t,e,r,o)}async boot(){if(this.lifecycle!=="booting"){console.warn("[ClientManager] Already booted or destroyed");return}this.log("\u26A1 Phase: BOOT");try{for(let t of this.extensions)t.onBoot&&(this.log(`\u2192 Extension onBoot: ${t.name}`),await t.onBoot({debug:this.debug,config:{},cconfig:this.config}));this.hooks.onBoot&&(this.log("\u2192 Calling onBoot hook"),await this.hooks.onBoot()),this.log("\u2713 BOOT phase complete");}catch(t){throw console.error("[ClientManager] Boot failed:",t),t}}async ready(){if(this.lifecycle!=="booting"){console.warn("[ClientManager] Cannot ready - not in booting phase");return}this.log("\u26A1 Phase: READY");try{let t="body";document.querySelector(t).id="root",this.mount(t),this.log("\u2192 Router mounted");for(let e of this.extensions)e.onReady&&(this.log(`\u2192 Extension onReady: ${e.name}`),await e.onReady({debug:this.debug,config:{},cconfig:this.config}));this.hooks.onReady&&(this.log("\u2192 Calling onReady hook"),await this.hooks.onReady()),this.lifecycle="ready",this.log("\u2713 READY phase complete"),this.log("\u2713 App is ready!");}catch(t){throw console.error("[ClientManager] Ready failed:",t),t}}async destroy(){if(this.lifecycle==="destroyed"){console.warn("[ClientManager] Already destroyed");return}this.lifecycle="destroying",this.log("\u26A1 Phase: DESTROY");try{for(let t=this.extensions.length-1;t>=0;t--){let e=this.extensions[t];e.onDestroy&&(this.log(`\u2192 Extension onDestroy: ${e.name}`),await e.onDestroy({debug:this.debug,config:{},cconfig:this.config}));}this.hooks.onDestroy&&(this.log("\u2192 Calling onDestroy hook"),await this.hooks.onDestroy()),this.eventsManager.destroy(),this.windowManager.destroy(),this.lifecycle="destroyed",this.log("\u2713 DESTROY phase complete");}catch(t){throw console.error("[ClientManager] Destroy failed:",t),t}}navigate(t){this.router.push(t);}mount(t){let e=typeof t=="string"?document.querySelector(t):t;if(!e){console.warn("[ClientManager] Mount target not found:",t);return}let r=e;if(this.config.rootLayout)try{let o=this.config.rootLayout();if(o){mount(o,e),this.log("\u2192 Root layout mounted");let n=e.querySelector("#main-overlay");n?r=n:console.warn("[ClientManager] Page slot #main-overlay not found in root layout. Pages will render to the root container.");}}catch(o){console.error("[ClientManager] Error rendering root layout:",o),e.innerHTML="<p>Error loading root layout</p>";return}effect(()=>{let o=this.currentPathSignal(),n=this.routeComponents[o]||this.config.notFoundComponent||null;if(r.innerHTML="",n)try{let a=n();a&&mount(a,r);}catch(a){console.error("[ClientManager] Error rendering component:",o,a),r.innerHTML="<p>Error loading component</p>";}else r.innerHTML="<p>No component found for this route</p>";this.log(`\u2192 Route changed to: ${o}`);}),this.log("\u2192 Routing setup complete");}getCurrentPath(){return this.currentPathSignal}createLinkHandler(t){return e=>{e.preventDefault(),this.navigate(t);}}getRouter(){return this.router}off(t,e,r){this.eventsManager.off(t,e,r);}getEventsManager(){return this.eventsManager}getViewport(){return this.windowManager.getViewport()}getWindowManager(){return this.windowManager}getI18n(){return window.__i18n}t(t,e,r){return window.__i18n?window.__i18n.t(t,e)??r??t:(console.warn("[ClientManager] i18n not initialized. Using default value or key."),r??t)}getPhase(){return this.lifecycle}isReady(){return this.lifecycle==="ready"}log(t){this.debug&&console.log(`[ClientManager] ${t}`);}},v=()=>x,g=()=>v()?.getRouter(),W=()=>g()?.back(),$=()=>g()?.forward(),j=i=>g()?.push(i),K=i=>g()?.replace(i),R=()=>v()?.getI18n(),Y=()=>R()?.getLanguage(),J=i=>R()?.setLanguage(i),z=(i,t,e)=>v()?.t(i,t,e),X=(i,t,e,r)=>R()?.tLang(i,t,e,r)??r??t;async function et(i){let t=document.querySelector('meta[name="app-i18n"]');if(t){let r=JSON.parse(t.getAttribute("content")||"{}");i.i18n=r;}let e=new d(i);return window.__i18n=await setupI18n(i.i18n||{defaultLanguage:"en",supportedLanguages:["en"]}),e.boot(),e.ready(),window.addEventListener("beforeunload",async()=>{await e.destroy();}),e}
export{v as CM,d as ClientManager,l as NavigationError,W as back,$ as forward,R as getI18n,Y as getLang,g as getRouter,j as push,K as replace,J as setLang,et as start,z as t,X as tLang};//# sourceMappingURL=index.js.map
//# sourceMappingURL=index.js.map